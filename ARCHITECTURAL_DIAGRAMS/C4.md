
## C4 Architecture Diagrams

### System Context Diagram (Level 1)
```
┌────────────────────────────────────────────────────────────────────────┐
│                         SYSTEM CONTEXT                                 │
└────────────────────────────────────────────────────────────────────────┘

         ┌─────────────┐                    ┌─────────────┐
         │  Customer   │                    │    Staff    │
         │  (Mobile    │                    │ (Operations │
         │   App)      │                    │  Dashboard) │
         └──────┬──────┘                    └──────┬──────┘
                │                                  │
                │ Booking, Unlock,                 │ Task Management,
                │ Payment, Feedback                │ Maintenance Logs
                │                                  │
                ▼                                  ▼
        ┌───────────────────────────────────────────────────┐
        │                                                   │
        │         MobilityCorp Platform                     │
        │  (Microservices + AI/ML + IoT + Events)           │
        │                                                   │
        └───────────────────────────────────────────────────┘
                │              │              │
                │              │              │
        ┌───────▼──────┐  ┌────▼─────┐  ┌────▼─────────┐
        │   IoT        │  │ External │  │  Payment     │
        │  Vehicles    │  │   APIs   │  │  Gateway     │
        │ (Telemetry,  │  │ (Weather,│  │  (Stripe,    │
        │  GPS, NFC)   │  │  Events, │  │   Adyen)     │
        └──────────────┘  │ Holidays)│  └──────────────┘
                          └──────────┘
```

**Key External Systems:**
- **Customers:** Mobile app users booking and using vehicles
- **Staff:** Operations team managing fleet via web dashboard
- **IoT Vehicles:** Bikes, scooters, cars, vans with embedded sensors
- **External APIs:** Weather (OpenWeatherMap), Events (PredictHQ), Holidays (Calendarific)
- **Payment Gateway:** Stripe/Adyen for transaction processing

---

### Container Diagram (Level 2)
```
┌────────────────────────────────────────────────────────────────────────┐
│                      CONTAINER ARCHITECTURE                            │
└────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                         FRONTEND LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │   Mobile     │  │  Operations  │  │  Admin       │             │
│  │   App        │  │  Dashboard   │  │  Portal      │             │
│  │  (React      │  │  (React)     │  │  (React)     │             │
│  │   Native)    │  │              │  │              │             │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘             │
└─────────┼──────────────────┼──────────────────┼───────────────────┘
          │                  │                  │
          │                  │                  │
┌─────────▼──────────────────▼──────────────────▼───────────────────┐
│                      API GATEWAY LAYER                             │
├────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────┐            │
│  │  API Gateway (Kong/AWS API Gateway)                │            │
│  │  • Authentication (OAuth2/JWT)                     │            │
│  │  • Rate Limiting                                   │            │
│  │  • Request Routing                                 │            │
│  └────────────────────┬───────────────────────────────┘            │
└───────────────────────┼────────────────────────────────────────────┘
                        │
┌───────────────────────▼────────────────────────────────────────────┐
│                    CORE SERVICES LAYER                             │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │   Booking    │  │   Payment    │  │   User/KYC   │            │
│  │   Service    │  │   Service    │  │   Service    │            │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘            │
│         │                  │                  │                    │
│  ┌──────▼───────┐  ┌──────▼───────┐  ┌──────▼───────┐            │
│  │   Vehicle    │  │  Telemetry   │  │    Fleet     │            │
│  │  Management  │  │   Service    │  │  Operations  │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
                        │
┌───────────────────────▼────────────────────────────────────────────┐
│                  AI/ML SERVICES LAYER  ⭐                          │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐ │
│  │  Demand          │  │  Dynamic Pricing │  │  Predictive     │ │
│  │  Forecasting     │  │  & Incentive     │  │  Maintenance    │ │
│  │  Engine          │  │  Engine          │  │  Engine         │ │
│  └──────────────────┘  └──────────────────┘  └─────────────────┘ │
│                                                                    │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐ │
│  │  Vision AI       │  │  Conversational  │  │  Multi-Provider │ │
│  │  (Damage         │  │  AI Assistant    │  │  AI Orchestrator│ │
│  │  Detection)      │  │  (MCP)           │  │                 │ │
│  └──────────────────┘  └──────────────────┘  └─────────────────┘ │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
                        │
┌───────────────────────▼────────────────────────────────────────────┐
│                   DATA & EVENT LAYER                               │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌────────────────────────────────────────────────────┐            │
│  │  Apache Kafka (Event Bus)                          │            │
│  │  Topics: bookings.*, vehicles.*, predictions.*     │            │
│  └────────────────────────────────────────────────────┘            │
│                                                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  PostgreSQL  │  │    Redis     │  │     S3       │            │
│  │  (Relational)│  │   (Cache)    │  │  (Storage)   │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│                                                                    │
│  ┌──────────────┐  ┌──────────────┐                               │
│  │ TimescaleDB  │  │  VictoriaM.  │                               │
│  │ (Telemetry)  │  │  (Metrics)   │                               │
│  └──────────────┘  └──────────────┘                               │
└────────────────────────────────────────────────────────────────────┘
                        │
┌───────────────────────▼────────────────────────────────────────────┐
│               INFRASTRUCTURE & OBSERVABILITY                       │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐ │
│  │ OpenTelemetry    │  │   Grafana        │  │   PagerDuty     │ │
│  │ (Tracing/Logs)   │  │  (Dashboards)    │  │   (Alerts)      │ │
│  └──────────────────┘  └──────────────────┘  └─────────────────┘ │
│                                                                    │
│  ┌──────────────────┐  ┌──────────────────┐                       │
│  │  Airflow         │  │   Temporal       │                       │
│  │  (Batch ML)      │  │  (Workflows)     │                       │
│  └──────────────────┘  └──────────────────┘                       │
└────────────────────────────────────────────────────────────────────┘
```

### Key Components:

* **Frontend:** Mobile app (customers), operations dashboard (staff), admin portal
* **API Gateway:** Single entry point with auth, rate limiting, routing
* **Core Services:** Business logic microservices (booking, payment, vehicle management, etc.)
* **AI/ML Services:** Specialized services for demand forecasting, dynamic pricing, predictive maintenance, vision AI, conversational AI
* **Event Bus:** Kafka for asynchronous, real-time event streaming
* **Data Stores:** PostgreSQL (transactional), Redis (cache), S3 (object storage), TimescaleDB (telemetry), VictoriaMetrics (metrics)
* **Observability:** OpenTelemetry, Grafana, PagerDuty
* **Orchestration:** Airflow (batch ML pipelines), Temporal (event-driven workflows)


### AI/ML Component Diagram (Level 3)

```
┌────────────────────────────────────────────────────────────────────────┐
│                     AI/ML ARCHITECTURE DETAIL                          │
└────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                    DATA INGESTION & PREPARATION                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Kafka Topics ───────► Feature Store (Feast/Tecton)                │
│  • bookings.*           • Real-time features                        │
│  • vehicles.*           • Historical aggregates                     │
│  • weather.data         • Feature versioning                        │
│  • events.data                                                      │
│                                                                     │
│  S3 Data Lake ────────► Offline Training Data                       │
│  • Historical bookings  • Anonymized datasets                       │
│  • Telemetry archives   • Regional partitioning                     │
│  • Customer behavior    • Compliance-filtered                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    MODEL TRAINING PIPELINES                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Airflow DAGs (Batch Training):                                    │
│  ┌────────────────────────────────────────────────────┐            │
│  │  1. Demand Forecasting (Weekly)                    │            │
│  │     • Model: XGBoost / LSTM                        │            │
│  │     • Features: Time, weather, events, history     │            │
│  │     • Output: 15-min demand predictions per 500m   │            │
│  │                                                    │            │
│  │  2. Predictive Maintenance (Weekly)                │            │
│  │     • Model: Isolation Forest + LSTM               │            │
│  │     • Features: Battery voltage curves, vibration  │            │
│  │     • Output: 7-14 day failure predictions         │            │
│  │                                                    │            │
│  │  3. Vision Models (Monthly)                        │            │
│  │     • Model: MobileNetV3 + YOLOv8-nano             │            │
│  │     • Training: Labeled damage images              │            │
│  │     • Output: Damage classification models         │            │
│  └────────────────────────────────────────────────────┘            │
│                                                                     │
│  MLflow / Weights & Biases:                                        │
│  • Experiment tracking                                             │
│  • Model versioning                                                │
│  • Hyperparameter tuning                                           │
│  • Performance metrics                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    MODEL REGISTRY & DEPLOYMENT                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Model Registry (MLflow):                                          │
│  • Versioned models per region                                     │
│  • Model metadata (training data, metrics, artifacts)              │
│  • Staging → Production promotion workflow                         │
│  • Rollback capability                                             │
│                                                                     │
│  Deployment Strategies:                                            │
│  • Canary rollouts (5% → 25% → 100%)                               │
│  • A/B testing infrastructure                                      │
│  • Shadow deployment for validation                                │
│  • Blue-green for zero-downtime updates                            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    INFERENCE SERVICES (Runtime)                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────┐              │
│  │  Demand Forecasting Service                       │              │
│  │  • Input: Location, time, weather, events         │              │
│  │  • Model: XGBoost/LSTM (region-specific)          │              │
│  │  • Output: Demand probability distribution        │              │
│  │  • Latency: <500ms                                │              │
│  │  • Publishes: predictions.demand_forecast         │              │
│  └───────────────────────────────────────────────────┘              │
│                                                                    │
│  ┌───────────────────────────────────────────────────┐             │
│  │  Dynamic Pricing Engine                           │             │
│  │  • Input: Demand forecast + current supply        │             │
│  │  • Logic: Supply-demand multipliers               │             │
│  │  • Output: Zone-specific pricing                  │             │
│  │  • Latency: <100ms                                │             │
│  │  • Publishes: pricing.updated                     │             │
│  └────────────────────────────────────────────────────              |
│                                                                     │
│  ┌───────────────────────────────────────────────────┐             │
│  │  Predictive Maintenance Service                   │             │
│  │  • Input: Vehicle telemetry streams               │             │
│  │  • Model: Isolation Forest + LSTM                 │             │
│  │  • Output: Failure probability + lead time        │             │
│  │  • Latency: Near real-time (streaming)            │             │
│  │  • Publishes: predictions.maintenance_alert       │             │
│  └───────────────────────────────────────────────────┘             │
│                                                                     │
│  ┌───────────────────────────────────────────────────┐             │
│  │  Vision AI Service (Damage Detection)             │             │
│  │  • Input: Pickup/dropoff photos                   │             │
│  │  • Model: MobileNetV3 + YOLOv8-nano               │             │
│  │  • Processing: Edge (privacy) + Cloud (backup)    │             │
│  │  • Output: Damage classification + confidence     │             │
│  │  • Latency: <2s                                   │             │
│  │  • Publishes: photos.verified                     │             │
│  └───────────────────────────────────────────────────┘             │
│                                                                     │
│  ┌───────────────────────────────────────────────────┐             │
│  │  Conversational AI (MCP Integration)              │             │
│  │  • Input: User text/voice messages                │             │
│  │  • NLU: Multi-provider LLM (OpenAI/Anthropic)     │             │
│  │  • Intent extraction + entity recognition         │             │
│  │  • MCP command execution (bookings, queries)      │             │
│  │  • Output: Natural language responses             │             │
│  │  • Latency: <3s                                   │             │
│  └───────────────────────────────────────────────────┘             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│              MULTI-PROVIDER AI ORCHESTRATOR  ⭐                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Provider Abstraction Layer:                                       │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐        │
│  │   OpenAI    │  Anthropic  │   Gemini    │   Azure     │        │
│  │   (US)      │   (EU)      │  (Global)   │  OpenAI(EU) │        │
│  └─────────────┴─────────────┴─────────────┴─────────────┘        │
│                                                                     │
│  Routing Logic:                                                    │
│  • Region-based selection (compliance)                             │
│  • Cost optimization (dynamic pricing)                             │
│  • Latency requirements                                            │
│  • Failover on provider outage                                     │
│  • Circuit breaker pattern                                         │
│                                                                     │
│  Monitoring:                                                       │
│  • Provider health checks                                          │
│  • Cost tracking per provider                                      │
│  • Latency and error rate metrics                                  │
│  • Usage quotas and throttling                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  MODEL MONITORING & OBSERVABILITY                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Real-Time Monitoring (Prometheus + VictoriaMetrics):              │
│  • Prediction latency (p50, p95, p99)                              │
│  • Model confidence distributions                                  │
│  • Error rates (false positives/negatives)                         │
│  • Resource utilization (CPU, memory, GPU)                         │
│                                                                     │
│  Data Quality Monitoring:                                          │
│  • Feature drift detection (Evidently AI)                          │
│  • Data distribution shifts                                        │
│  • Missing/anomalous values                                        │
│  • Schema validation                                               │
│                                                                     │
│  Model Performance Tracking:                                       │
│  • Accuracy metrics vs. ground truth                               │
│  • Business impact metrics (revenue, cost savings)                 │
│  • A/B test results                                                │
│  • Customer satisfaction correlation                               │
│                                                                     │
│  Alerting (PagerDuty + Slack):                                     │
│  • Model drift threshold exceeded                                  │
│  • Prediction accuracy degradation                                 │
│  • Inference service failures                                      │
│  • Provider outages or cost spikes                                 │
│                                                                     │
│  Dashboards (Grafana):                                             │
│  • ML system health overview                                       │
│  • Per-model performance metrics                                   │
│  • Cost and usage analytics                                        │
│  • Regional deployment status                                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    FEEDBACK & RETRAINING LOOP                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Ground Truth Collection:                                          │
│  • Actual bookings vs. demand forecasts                            │
│  • Confirmed maintenance events vs. predictions                    │
│  • Manual damage verification vs. AI classification                │
│  • User feedback on AI recommendations                             │
│                                                                     │
│  Automated Retraining Triggers (Temporal):                         │
│  • Scheduled: Weekly for forecasting models                        │
│  • Drift-based: Triggered when accuracy drops >10%                 │
│  • Event-based: New city launch, seasonal changes                  │
│  • Manual: Operations team override                                │
│                                                                     │
│  Continuous Learning Pipeline:                                     │
│  1. Collect labeled data from production                           │
│  2. Augment training dataset                                       │
│  3. Retrain model with updated data                                │
│  4. Validate against holdout set                                   │
│  5. Shadow deploy for A/B testing                                  │
│  6. Promote to production if metrics improve                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Edge-Cloud Hybrid Telemetry Architecture
```
┌────────────────────────────────────────────────────────────────────────┐
│              EDGE-CLOUD HYBRID TELEMETRY ARCHITECTURE                  │
└────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                        VEHICLE EDGE LAYER                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌────────────────────────────────────────────────────┐            │
│  │  IoT Hardware (ARM Processor + Sensors)            │            │
│  │  • GPS/GNSS Module                                 │            │
│  │  • IMU/Accelerometer (collision detection)         │            │
│  │  • Battery Management System (BMS)                 │            │
│  │  • Camera (pickup/dropoff verification)            │            │
│  │  • NFC/Bluetooth (unlock/lock)                     │            │
│  │  • 4G/5G Modem (connectivity)                      │            │
│  └────────────────────────────────────────────────────┘            │
│                         │                                          │
│                         ▼                                          │
│  ┌────────────────────────────────────────────────────┐            │
│  │  Edge Processing Module (Lightweight ML)           │            │
│  │                                                    │            │
│  │  Collision Detection Model:                       │            │
│  │  • Input: IMU data (50Hz), wheel slip, ABS        │            │
│  │  • Model: Quantized Neural Network (<5MB)         │            │
│  │  • Latency: <100ms                                │            │
│  │  • Fallback: Rule-based (g-force >4G)             │            │
│  │  • Action: Immediate alert + disable vehicle      │            │
│  │                                                    │            │
│  │  Damage Detection Model:                          │            │
│  │  • Input: Pickup/dropoff photos                   │            │
│  │  • Model: MobileNetV3 (<10MB)                     │            │
│  │  • Privacy: Generate blurred thumbnails           │            │
│  │  • Output: Damage classification + confidence     │            │
│  │  • Upload: Only metadata + embeddings (not raw)   │            │
│  │                                                    │            │
│  │  Telemetry Aggregation:                           │            │
│  │  • GPS: 30s intervals → compressed batches        │            │
│  │  • Battery: 60s intervals → voltage curves        │            │
│  │  • Vibration: FFT analysis → anomaly scores       │            │
│  │  • Compression: Protocol Buffers + gzip           │            │
│  └────────────────────────────────────────────────────┘            │
│                         │                                          │
│                         ▼                                          │
│  ┌────────────────────────────────────────────────────┐            │
│  │  Secure Communication (mTLS)                       │            │
│  │  • Device certificates for authentication          │            │
│  │  • End-to-end encryption (TLS 1.3)                 │            │
│  │  • Retry logic with exponential backoff            │            │
│  │  • Offline buffering (up to 24h)                   │            │
│  └────────────────────────────────────────────────────┘            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                     MQTT/HTTPS over 4G/5G
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        CLOUD INGESTION LAYER                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌────────────────────────────────────────────────────┐            │
│  │  IoT Gateway (AWS IoT Core / Azure IoT Hub)        │            │
│  │  • Device authentication (mTLS)                    │            │
│  │  • Message validation and routing                  │            │
│  │  • Protocol translation (MQTT → Kafka)             │            │
│  │  • Device shadow state management                  │            │
│  └────────────────────────────────────────────────────┘            │
│                         │                                          │
│                         ▼                                          │
│  ┌────────────────────────────────────────────────────┐            │
│  │  Kafka Topics (Event Bus)                          │            │
│  │  • vehicles.telemetry (GPS, battery)               │            │
│  │  • vehicles.collision_detected                     │            │
│  │  • photos.uploaded (damage verification)           │            │
│  │  • vehicles.health (predictive maintenance)        │            │
│  └────────────────────────────────────────────────────┘            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     CLOUD PROCESSING LAYER                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Stream Processing (Kafka Streams):                                │
│  ┌────────────────────────────────────────────────────┐            │
│  │  • Real-time aggregations (fleet status)           │            │
│  │  • Anomaly detection (battery drain, vibration)    │            │
│  │  • Geofencing alerts (wrong location)              │            │
│  │  • Trip reconstruction from GPS points             │            │
│  └────────────────────────────────────────────────────┘            │
│                                                                     │
│  Batch Processing (Airflow):                                       │
│  ┌────────────────────────────────────────────────────┐            │
│  │  • Daily: Historical telemetry ETL to S3           │            │
│  │  • Weekly: Feature extraction for ML training      │            │
│  │  • Monthly: Vehicle health reports                 │            │
│  └────────────────────────────────────────────────────┘            │
│                                                                     │
│  Data Storage:                                                     │
│  ┌────────────────────────────────────────────────────┐            │
│  │  TimescaleDB (Time-Series):                        │            │
│  │  • GPS coordinates, battery voltage curves         │            │
│  │  • Retention: 90 days hot, 2 years cold (S3)       │            │
│  │                                                    │            │
│  │  S3 (Object Storage):                              │            │
│  │  • Raw telemetry archives (compliance)             │            │
│  │  • Anonymized datasets (ML training)               │            │
│  │  • Damage photos (encrypted, 7-day TTL)            │            │
│  │                                                    │            │
│  │  PostgreSQL (Relational):                          │            │
│  │  • Vehicle metadata, trip summaries                │            │
│  │  • Maintenance records, incident logs              │            │
│  └────────────────────────────────────────────────────┘            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```